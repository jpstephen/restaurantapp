@model IEnumerable<Items>

@{
    ViewData["Title"] = "Home Page";
}

@{
    var itemcount = 0;
}

<div class="row">
    <div class="col-md-8">
        <div class="row">
    @foreach (var item in Model)
        {
            if(itemcount < 3)
            {

            @*if(itemcount == 0)
                {
                    <div class="row">
                }*@

                var no_of_items = @item.Name.Replace(' ','_') + "_value";

                <div class="col-xl-3">@item.Name &nbsp;&nbsp;&nbsp;&nbsp; @item.Price aed<br /><br />
                    <input type="number" id=@no_of_items value="1" style="width:40px;height:40px;" /> 
                    <a class="btn btn-lg btn-primary" onclick="addToBill('@item.Name.Replace(' ','_')',@item.Price)">
                        <i class="bi bi-file-plus-fill"></i>Add</a>
                    <br />
                    <br />
                </div>

                

                itemcount++;
            }
            if(itemcount == 2)
            {
                itemcount = 0;
            }
        }
        </div>
    </div>
    <div class="col-md-4" id="billsection"></div>
</div>

<script>
var itemsinbill = [];
var iteminbillid = 0;

    function addToBill(name, price) {
        var itemadded = { "id": 0, "name": "", "price": 0, "quantity": 0, "total": 0 };

        iteminbillid++;

        itemadded.id = iteminbillid;
        itemadded.name = name.replace("_"," ");
        itemadded.price = price;
        itemadded.quantity = document.getElementById(name + "_value").value;
        itemadded.total = price * document.getElementById(name + "_value").value;

        addInBillArray(itemadded);

        console.log("added", itemadded);

        createtable();

    }


function addInBillArray(itemadded){

    var itemalreadyinbill = "no";

    itemsinbill.forEach(function(item) {

        if (item.name == itemadded.name) {

            itemalreadyinbill = "yes";
            item.quantity = parseInt(itemadded.quantity) + parseInt(item.quantity);
            item.total = item.quantity * item.price;
           
        }

    });

    if (itemalreadyinbill == "no") {
        itemsinbill.push(itemadded);
    }
}


function createtable() {

    float billtotal = 0;

    var tablehtml = "<table class='table-condensed' width='100%'><tr><th colspan=5 align='center'>BILL</th></tr>";
    tablehtml += "<tr><th>Item</th><th>Price</th><th>Quantity</th><th>Total</th><th></th></tr>"

    itemsinbill.forEach(function(item) {

        billtotal += parseInt(item.total);

        tablehtml += "<tr><td>" + item.name + 
        "</td>" + "<td>" + item.price + "</td>" + 
        "<td>" + item.quantity + "</td>" +"<td>" + item.total + 
        "</td><td><a class='btn btn-sm btn-outline-danger' style='height:20px' onclick='deletefrombill("+item.id+")'><i class='bi bi-trash' ></i></a></td></tr>";
});
    tablehtml += "<tr><td style='height:30px;'></td><td></td><td></td><td></td><td></td></tr>"
    tablehtml += "<tr><td></td><td></td><td></td><td colspan='2'>Total = "+billtotal.toString("0.00")+" aed</td></tr>"
    tablehtml += "<tr><td style='height:30px;'></td><td></td><td></td><td></td><td></td></tr>"
    tablehtml += "<tr><td style='height:30px;'></td><td></td><td><a class='btn btn-lg btn-secondary' onclick='generatebill()'>BILL</a></td><td></td><td></td></tr>"
    tablehtml += "</table>";
    //tablehtml += "<br />";
    //tablehtml += "<form method='post' asp-controller='Home' asp-action='GeneratePDF'><input type='submit' value='BILL' /></form>"

    document.getElementById("billsection").innerHTML = tablehtml;
}

function deletefrombill(id) {
    itemsinbill.forEach(function(item) {
    
        console.log("itemid", item.id);
        console.log("id", id);
        if (item.id == id) {
            const index = itemsinbill.indexOf(item);
            if (index > -1) { 
              itemsinbill.splice(index, 1); 
            }
        }

    });

    createtable();
}

function generatebill() {


    var allbills = itemsinbill.toString();

    window.open('@Url.Action("GeneratePDF", "Home")' + '?allbills=' + JSON.stringify(itemsinbill), '_blank');

}
</script>